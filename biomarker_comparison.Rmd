---
title: "Biomarker comparison across 8 cell lines"
author: "[John Zobolas](https://github.com/bblodfon)"
output:
  html_document:
    df_print: paged
    theme: united # also good: default, cosmo, readable
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: false
    #self_contained: no
---

## Intro

In this notebook we will compare the biomarker results from 8 different cell 
lines. The results were obtained through an ensemble model analysis, which was
performed on the models generated by the `Gitsbe` module when running the 
DrugLogics computational pipeline for finding synergistic drug combinations 
(drug pairs). The models in each different cell line setup were trained towards 
a specific signaling activity profile matching the activity state of that 
particular cell line. For more info about **the cell line specific model & 
biomarker analysis, see the respective notebooks:**

- [A498](https://bblodfon.github.io/gitsbe-model-analysis/A498_model_analysis.html)
- [AGS](https://bblodfon.github.io/gitsbe-model-analysis/AGS_model_analysis.html)
- [colo205](https://bblodfon.github.io/gitsbe-model-analysis/colo205_model_analysis.html)
- [DU145](https://bblodfon.github.io/gitsbe-model-analysis/DU145_model_analysis.html)
- [MDA-MB-468](https://bblodfon.github.io/gitsbe-model-analysis/MDA-MB-468_model_analysis.html)
- [SF295](https://bblodfon.github.io/gitsbe-model-analysis/SF295_model_analysis.html)
- [SW620](https://bblodfon.github.io/gitsbe-model-analysis/SW620_model_analysis.html)
- [UACC62](https://bblodfon.github.io/gitsbe-model-analysis/UACC62_model_analysis.html)

Note that the biomarkers identified in the aforementioned notebooks, were 
classified as:
- Performance-related biomarkers, which represent important nodes that make our 
models achieve a higher model performance classification (the methodology was 
based on the number of $TP$ (true positives) and the $MCC$ (Mathews Correlation 
Coefficient) score)
- Per synergy predicted biomarkers, which represent important nodes that make 
our models predict (cell line specific) observed synergies

In each category, the biomarkers can be either in *an active state* or in *an
inhibited state*. The input for the simulations and the output data are in the 
`cell-lines-2500` directory (the 2500 number denotes the number of simulations 
executed). The analysis will be presented step by step in the sections below.

## Prerequisites

Firstly, we load the required libraries (you need to install them if you don't
have them):
```{r Load libraries, message = FALSE}
library(superheat) # version 1.0.0, see (Barter, 2017)
```
and the relevant helper functions:
```{r Helper functions}
# Set the working directory to the gitsbe-model-analysis folder: 
# setwd("pathTo/gitsbe-model-analysis")
source("Rscripts/input_functions.R")
source("Rscripts/output_functions.R")
source("Rscripts/analysis_functions.R")
```

The R version used for this analysis is: 
```{r R version, results = 'asis'}
pretty.print.string(R.version.string)
```

## Input

Firstly, we define the necessary input (cell line names, directories and files 
of interest, etc.):
```{r Input}
cell.lines = c("A498", "AGS", "colo205", "DU145", "MDA-MB-468", "SF295", 
               "SW620", "UACC62")

cell.lines.dirs = sapply(cell.lines, function(cell.line) {
  paste0(getwd(), "/cell-lines-2500/", cell.line)
})

biomarkers.dirs = sapply(cell.lines.dirs, function(cell.line.dir) {
  paste0(cell.line.dir, "/biomarkers")
})

observed.synergies.files = sapply(cell.lines.dirs, function(cell.line.dir) {
  paste0(cell.line.dir, "/observed_synergies")
})

# get the drug combinations tested
model.predictions.file = paste0(cell.lines.dirs[1], "/model_predictions")
model.predictions = get.model.predictions(model.predictions.file)
drug.combinations.tested = colnames(model.predictions)

# get the node names (same topology for all cell lines)
models.dir = paste0(cell.lines.dirs[1], "/models")
node.names = get.node.names(models.dir)
```

## Performance Biomarkers

Next, we will visualize the performance biomarkers per cell line:
```{r Performance Biomarkers Heatmap, fig.height = 7, fig.width = 9, dpi = 300}
biomarkers.perf.active = 
  get.perf.biomarkers.per.cell.line(biomarkers.dirs, type = "active")

biomarkers.perf.inhibited =
  get.perf.biomarkers.per.cell.line(biomarkers.dirs, type = "inhibited")

biomarkers.perf.res = 
  merge.perf.biomarkers(node.names, cell.lines, biomarkers.perf.active, 
                        biomarkers.perf.inhibited)

# remove nodes which are not biomarkers for any cell line
biomarkers.perf.res = prune.columns.from.df(biomarkers.perf.res, value = 0)

superheat(biomarkers.perf.res, title.alignment = "center", title.size = 7,
          title = paste0("Biomarker results per cell line"),
          row.dendrogram = TRUE, col.dendrogram = TRUE, scale = FALSE,
          column.title = "Network Nodes", row.title = "Cell Lines",
          heat.pal = c("tomato", "grey", "gold"),
          # grey   = not a biomarker
          # tomato = inhibited biomarker
          # gold   = active biomarker
          force.grid.vline = TRUE, force.grid.hline = TRUE,
          grid.vline.size = 0.1, grid.hline.size = 0.1, 
          legend.breaks = c(-1, 0, 1),
          left.label.col = "white", left.label.text.size = 5,
          bottom.label.col = "white",
          bottom.label.text.size = 1.7, bottom.label.text.angle = 90)
```

- Across all cell lines, a total of `r ncol(biomarkers.perf.res)` performance 
biomarkers were found
- The three gastro-related cell lines (`AGS,SW620,colo205`) have a lot of common
biomarkers
- In general the biomarker results are different between the cell lines
- There exist unique biomarkers per cell line which are not shared with any 
other cell line 
- There are common biomarkers between the cell lines in either tha same activity 
state (`SW620` vs `AGS`) or the reverse (`SW620` vs `colo205`)

## Observed synergies

Each of the cell lines studied, has a different set of observed synergies (drug 
combinations that were found synergistic across all the 
`r length(drug.combinations.tested)` tested ones). In this section, we will 
visualize the cell lines' observed synergies and mark the synergies that were 
also predicted by the cell-specific models:
```{r Total predicted synergies by the cell-specific models}
biomarkers.per.synergy = get.synergy.biomarkers.per.cell.line(biomarkers.dirs)

total.predicted.synergies = character(0)
for (cell.line in cell.lines) {
  total.predicted.synergies = 
    c(total.predicted.synergies, rownames(biomarkers.per.synergy[cell.line][[1]]))
}
total.predicted.synergies = unique(total.predicted.synergies)
total.predicted.synergies.num = length(total.predicted.synergies)
```

```{r Observed synergies per cell line, fig.height = 7, fig.width = 9, dpi = 300}
observed.synergies.per.cell.line = sapply(
  observed.synergies.files, function(observed.synergies.file) {
    get.observed.synergies(observed.synergies.file)
})

observed.synergies.res = 
  merge.observed.synergies(drug.combinations.tested, cell.lines, 
                           observed.synergies.per.cell.line)

# remove drug combinations which are not observed in any of the cell lines
observed.synergies.res = prune.columns.from.df(observed.synergies.res, value = 0)

total.observed.synergies = colnames(observed.synergies.res)
total.observed.synergies.num = length(total.observed.synergies)
```

```{r Observed synergies Heatmap, fig.height = 7, fig.width = 9, dpi = 300}
# color the predicted synergies
predicted.synergies.colors = rep("black", total.observed.synergies.num)
names(predicted.synergies.colors) = total.observed.synergies
predicted.synergies.colors[total.observed.synergies %in% 
                          total.predicted.synergies] = "blue"

superheat(observed.synergies.res, title.alignment = "center", title.size = 7,
          title = paste0("Observed synergies per cell line"),
          row.dendrogram = TRUE, col.dendrogram = TRUE, scale = FALSE,
          column.title = "Drug Combinations", row.title = "Cell Lines",
          heat.pal = c("red", "green"),
          # red   = non-observed synergy
          # green = observed synergy
          force.grid.vline = TRUE, force.grid.hline = TRUE,
          grid.vline.size = 0.1, grid.hline.size = 0.1,
          legend.breaks = c(0, 1),
          left.label.col = "white", left.label.text.size = 5,
          bottom.label.col = "white", bottom.label.text.col = predicted.synergies.colors,
          bottom.label.text.size = 3, bottom.label.text.angle = 90)
```

- The *cell-specific* models predicted `r total.predicted.synergies.num` of the
`r total.observed.synergies.num` observed synergies found across the 
`r length(cell.lines)` cell lines - see blue-colored synergies in the heatmap 
above. Thus, the **total true positive coverage is 
`r total.predicted.synergies.num/total.observed.synergies.num`%**
- Note the common observed synergies among many cell lines (`PI-D1`,`AK-BI` 
for example)
- Cell line specfic synergies were identified by cell-specific models

```{r heatmap: per observed synergy: cell lines vs network nodes}


```



## References

1. Barter Rebecca, Yu Bin (2017) Superheat: An R package for creating beautiful and extendable heatmaps for visualizing complex data. [https://arxiv.org/abs/1512.01524](https://arxiv.org/abs/1512.01524), [https://rlbarter.github.io/superheat/](https://rlbarter.github.io/superheat/)
