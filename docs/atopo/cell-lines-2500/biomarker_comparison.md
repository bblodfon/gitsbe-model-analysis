# Biomarker comparison {-}

In this chapter we will compare the biomarker results from 8 different cell 
lines. These results were obtained through an ensemble model analysis, which was
performed on the models generated by the `Gitsbe` module when running the 
DrugLogics computational pipeline for finding synergistic drug combinations 
(drug pairs). The models in each different cell line setup were trained towards 
a specific signaling activity profile matching the activity state of that 
particular cell line. For more info about **the cell line specific model & 
biomarker analysis, see the respective chapters:**

- [A498 Model Analysis]
- [AGS Model Analysis]
- [DU145 Model Analysis]
- [Colo205 Model Analysis]
- [SW620 Model Analysis]
- [SF295 Model Analysis]
- [UACC62 Model Analysis]
- [MDA-MB-468 Model Analysis]

Note that the biomarkers identified in the aforementioned chapters, were 
classified as:

- **Performance-related biomarkers**, which represent important nodes that are essential for our models to achieve a higher model performance classification (the methodology was based on the number of true positives ($TP$) and the Matthews Correlation Coefficient score ($MCC$)
- **Per synergy predicted biomarkers**, which represent important nodes that are essential for our models to predict some of the synergies that were observed in the lab

In each category, the biomarkers can be either in *an active state* or in *an
inhibited state*. The input for the simulations and the output data are in the 
`cell-lines-2500` directory (the 2500 number denotes the number of simulations 
executed). The analysis will be presented step by step in the sections below.



## Input {-}

Firstly, we define the necessary input (cell line names, directories and files 
of interest, etc.):

```r
cell.lines = c("A498", "AGS", "DU145", "colo205", "SW620", "SF295", "UACC62", "MDA-MB-468")

cell.line.dirs = sapply(cell.lines, function(cell.line) {
  paste0(getwd(), "/", cell.line)
})

biomarkers.dirs = sapply(cell.line.dirs, function(cell.line.dir) {
  paste0(cell.line.dir, "/biomarkers")
})

# get the drug combinations tested
model.predictions.file = paste0(cell.line.dirs[1], "/model_predictions")
model.predictions = get_model_predictions(model.predictions.file)
drug.combos = colnames(model.predictions)

# get the node names (same topology for all cell lines)
models.dir = paste0(cell.line.dirs[1], "/models")
node.names = get_node_names(models.dir)
```

## Performance Biomarkers {-}

Next, we will visualize the performance biomarkers found from the **cell-specific 
model analysis** per cell line:

```r
biomarkers.perf.res = get_perf_biomarkers_per_cell_line(biomarkers.dirs, node.names)

# remove nodes which are not biomarkers for any cell line
biomarkers.perf.res = prune_columns_from_df(biomarkers.perf.res, value = 0)

# define a coloring
biomarkers.col.fun = colorRamp2(c(-1, 0, 1), c("tomato", "grey", "gold"))

perf.biomarkers.heatmap = 
  Heatmap(matrix = as.matrix(biomarkers.perf.res), col = biomarkers.col.fun,
        column_title = "Performance biomarkers per cell line",
        column_title_gp = gpar(fontsize = 20),
        row_title = "Cell Lines", row_title_side = "left",
        row_dend_side = "right", row_names_side = "left",
        column_names_gp = gpar(fontsize = 5),
        rect_gp = gpar(col = "black", lwd = 0.3),
        heatmap_legend_param = list(at = c(-1, 1), title = "Activity State",
          labels = c("Inhibited", "Active"), color_bar = "discrete", ncol = 2,
          title_position = "leftcenter", direction = "horizontal"))

draw(perf.biomarkers.heatmap, heatmap_legend_side = "bottom")
```

<img src="biomarker_comparison_files/figure-html/Performance Biomarkers Heatmap-1.png" width="2400" />

- Across all cell lines, a total of 91 performance 
biomarkers were found
- **The three gastrointestinal cell lines** (`AGS,SW620,colo205`) **have a lot of 
common biomarkers**. These common biomarkers between the cell lines can be in 
either the same activity state (`SW620` vs `AGS`) or the reverse (`SW620` vs 
`colo205`)
- **In general the biomarker results are different between the different type of 
cell lines**
- There exist unique biomarkers per cell line which are not shared with any of
the other cell lines

We save the results:

```r
save_df_to_file(df = biomarkers.perf.res, file = "perf_biomakrers_per_cell_line")
```

## Observed synergies {-}

Each of the cell lines studied has a different set of observed synergies (drug 
combinations that were found synergistic across all the 
153 tested ones). In this section, we will 
visualize the cell lines' observed synergies and mark the synergies that were 
also predicted by the cell-specific models. First, we get the biomarkers for 
these synergies from each cell line:

```r
synergy.biomarkers.cell.specific = 
  get_synergy_biomarkers_per_cell_line(biomarkers.dirs)

total.predicted.synergies.cell.specific =
  unique(unlist(sapply(synergy.biomarkers.cell.specific, function(df) { rownames(df) })))
total.predicted.synergies.cell.specific.num = 
  length(total.predicted.synergies.cell.specific)
```

Then, we get the observed synergies from each cell line:

```r
observed.synergies.res = get_observed_synergies_per_cell_line(cell.line.dirs, drug.combos)

# remove drug combinations which are not observed in any of the cell lines
observed.synergies.res = prune_columns_from_df(observed.synergies.res, value = 0)

total.observed.synergies = colnames(observed.synergies.res)
total.observed.synergies.num = length(total.observed.synergies)
```

Lastly, we visualize the observed and predicted synergies for all cell lines 
in one heatmap:

```r
# color the cell-specific predicted synergies
predicted.synergies.colors = rep("black", total.observed.synergies.num)
names(predicted.synergies.colors) = total.observed.synergies
predicted.synergies.colors[total.observed.synergies %in% 
                           total.predicted.synergies.cell.specific] = "blue"

# define a coloring
obs.synergies.col.fun = colorRamp2(c(0, 1), c("red", "green"))

observed.synergies.heatmap = 
  Heatmap(matrix = as.matrix(observed.synergies.res), 
          col = obs.synergies.col.fun,
          column_title = "Observed synergies per cell line",
          column_title_gp = gpar(fontsize = 20),
          column_names_gp = gpar(col = predicted.synergies.colors),
          row_title = "Cell Lines", row_title_side = "left",
          row_dend_side = "right", row_names_side = "left",
          rect_gp = gpar(col = "black", lwd = 0.3),
          heatmap_legend_param = list(at = c(1, 0), labels = c("YES", "NO"), 
            color_bar = "discrete", title = "Observed", direction = "vertical"))

lgd = Legend(at = "Cell-specific", title = "Predicted", 
             legend_gp = gpar(fill = "blue"))

draw(observed.synergies.heatmap,  heatmap_legend_list = list(lgd), 
     heatmap_legend_side = "right")
```

<img src="biomarker_comparison_files/figure-html/Observed synergies heatmap-1.png" width="2700" />

- The *cell-specific* models predicted 12 
of the 40 observed synergies found across the 
8 cell lines. Thus, the **total true positive coverage for 
the cell-specific models across all cell lines is 
0.3%**
- Note that there exist synergies which were observed in all cell lines (`AK-BI`,
`PI-D1`)
- Cell line specific synergies (e.g. `PD-PI`, `AK-PD` in the `A498` cell line) 
were identified only by the cell-specific models (**????? MAYBE! HAVE TO 
CHECK FIRST WITH RANDOM MODEL PREDICTIONS**)

## Synergy Biomarkers {-}

In this section, we will produce heatmaps showing the biomarkers across the 
8 cell lines for every observed synergy that was also 
predicted by the cell-specific models. First, we manipulate the biomarker 
result data to fit our purposes:


```r
synergy.biomarkers.cell.specific.res = ldf_arrange_by_rownames(synergy.biomarkers.cell.specific)

# For every synergy, remove cell lines that didn't predict the observed synergies
# at all or for which we couldn't find any biomarkers (row pruning).
# Also remove nodes which are not biomarkers for any cell line (column pruning)
for (synergy in names(synergy.biomarkers.cell.specific.res)) {
  df = synergy.biomarkers.cell.specific.res[[synergy]]
  df = prune_columns_from_df(df, value = 0)
  df = prune_rows_from_df(df, value = 0)
  synergy.biomarkers.cell.specific.res[[synergy]] = df
}

# re-order result list based on increasing number of cell lines
synergy.biomarkers.cell.specific.res = synergy.biomarkers.cell.specific.res[
  names(sort(sapply(synergy.biomarkers.cell.specific.res, function(x) { nrow(x) })))
]
```

Next, we produce the heatmaps (one per synergy predicted):

```r
for (synergy in names(synergy.biomarkers.cell.specific.res)) {
  biomarkers.res = as.matrix(synergy.biomarkers.cell.specific.res[[synergy]])
  
  # customize some parameters
  heatmap.height = ifelse(nrow(biomarkers.res) < 3, 1, 3)
  show.column.dend = ifelse(nrow(biomarkers.res) == 1, FALSE, TRUE)
  row.title = ifelse(nrow(biomarkers.res) == 1, "Cell Line", "Cell Lines")
  
  biomarkers.heatmap = 
    Heatmap(matrix = biomarkers.res, col = biomarkers.col.fun, 
            column_title = paste0("Biomarkers for Synergy: ", synergy),
            column_title_gp = gpar(fontsize = 20, fontface = "bold"),
            row_title = row.title, row_title_side = "right",
            rect_gp = gpar(col = "black", lwd = 0.3),
            column_names_gp = gpar(fontsize = 10),
            show_column_dend = show.column.dend,
            height = unit(heatmap.height, "inches"),
            heatmap_legend_param = list(at = c(-1, 1), title = "Activity State",
              labels = c("Inhibited", "Active"), color_bar = "discrete",
              title_position = "leftcenter", direction = "horizontal", ncol = 2))
  
  draw(biomarkers.heatmap, heatmap_legend_side = "bottom")
}
```

<img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-1.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-2.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-3.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-4.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-5.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-6.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-7.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-8.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-9.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-10.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-11.png" width="2700" /><img src="biomarker_comparison_files/figure-html/Biomarker Heatmaps for cell-specific predicted synergies-12.png" width="2700" />

The main result here is that we observe common biomarkers across many cell lines
and in the *same activity state* for some synergies, which hints that these 
biomarkers may have a **pan-cancer diagnostic value**.
